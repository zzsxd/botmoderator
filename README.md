# Bottgmoder — Telegram Moderation Bot

Бот предназначен для модерации групповых чатов Telegram. Он автоматически удаляет сообщения, содержащие запрещенные ключевые слова, предупреждает нарушителей и блокирует после заданного числа предупреждений. Управление ботом выполняется через отдельный администраторский чат или приватный диалог с админом. Логика обработки обновлений реализована в многопоточном режиме: один поток занимается долгим опросом Telegram API, а пул рабочих потоков параллельно обрабатывает входящие события.

## Возможности

- Добавление и удаление модерируемых чатов прямо из Telegram.
- Управление списком ключевых слов (добавление, удаление, просмотр).
- Автоматическое удаление нарушающих сообщений и уведомление пользователя.
- Учёт предупреждений и автоматический бан после превышения лимита.
- Просмотр текущей статистики предупреждений и ручной сброс счётчиков.
- Постоянное хранение состояния в JSON-файле с потокобезопасным доступом.

## Быстрый старт

1. Установите зависимости:
   ```bash
   python3 -m pip install -r requirements.txt
   ```
2. Создайте файл `.env` на основе примера:
   ```bash
   cp .env.example .env
   ```
   Укажите токен бота (`BOT_TOKEN`) и идентификаторы администраторских чатов в `BOT_ADMIN_CHAT_IDS` (через запятую). При необходимости дополнительно задайте `BOT_ADMIN_USER_IDS`.
3. Запустите бота:
   ```bash
   python3 main.py
   ```

Файл состояния (`BOT_STORAGE_PATH`, по умолчанию `moderation_state.json`) будет создан автоматически.

## Команды администратора

Все команды вводятся в админ-чате или приватном диалоге с ID, указанным в `BOT_ADMIN_USER_IDS`.

- `/add_chat <chat_id> [описание]` — добавить чат в список модерируемых.
- `/remove_chat <chat_id>` — удалить чат из списка.
- `/list_chats` — показать все модерируемые чаты и краткую статистику.
- `/add_keyword <chat_id> <слово>` — добавить ключевое слово для чата.
- `/remove_keyword <chat_id> <слово>` — удалить ключевое слово.
- `/list_keywords <chat_id>` — показать список ключевых слов по чату.
c- `/warnings <chat_id> [user_id]` — вывести все предупреждения по чату или конкретному пользователю.
- `/reset_warning <chat_id> <user_id>` — обнулить предупреждения пользователя.
- `/help` — отобразить краткую справку.

## Как работает авто-модерация

1. Бот получает обновления через long polling в отдельном потоке.
2. Каждое обновление передаётся в пул рабочих потоков для обработки без блокировки опроса.
3. При обнаружении в сообщении ключевых слов бот удаляет его, фиксирует предупреждение пользователя и отправляет уведомление.
4. После достижения лимита (`BOT_WARNING_LIMIT`, по умолчанию 3) происходит бан пользователя и уведомление администраторов.

## Переменные окружения

| Переменная | Назначение |
|------------|------------|
| `BOT_TOKEN` | Токен Telegram-бота. |
| `BOT_ADMIN_CHAT_IDS` | Список ID админских чатов (через запятую). |
| `BOT_ADMIN_USER_IDS` | (Опционально) список ID админских пользователей. |
| `BOT_WARNING_LIMIT` | Количество предупреждений до бана (по умолчанию 3). |
| `BOT_LONG_POLL_TIMEOUT` | Таймаут long polling в секундах. |
| `BOT_WORKER_POOL_SIZE` | Количество потоков-обработчиков обновлений. |
| `BOT_STORAGE_PATH` | Путь к JSON-файлу с состоянием. |
| `LOG_LEVEL` | Уровень логирования (`DEBUG`, `INFO`, `WARNING`, ...). |

## Дополнительно

- Для работы с ключевыми словами используется регистронезависимый поиск.
- Все операции записи выполняются атомарно (через временный файл) для защиты от повреждения состояния.
- Перед запуском убедитесь, что бот добавлен в модерируемые чаты и обладает правами администратора с разрешением на удаление сообщений и бан пользователей.

